(function(){this.SamplerCoreView=function(){function t(t,e,i){this.model=t,this.id=e,this.dom=i,this.sample=this.dom.find(".Sampler_sample"),this.canvas_waveform_dom=this.dom.find(".waveform"),this.canvas_waveform=this.canvas_waveform_dom[0],this.ctx_waveform=this.canvas_waveform.getContext("2d"),this.canvas_EQ_dom=this.dom.find(".canvasEQ"),this.canvas_EQ=this.canvas_EQ_dom[0],this.ctx_EQ=this.canvas_EQ.getContext("2d"),this.eq=this.dom.find(".Sampler_EQ"),this.output=this.dom.find(".Sampler_output"),this.panner=this.output.find(".pan-slider"),this.gain=this.output.find(".gain-slider"),this.sample_now=0,this.w_wave=300,this.h_wave=180,this.head_wave=0,this.tail_wave=this.w_wave,this.clicked_wave=0,this.target={head:this.head_wave,tail:this.tail_wave,both:[this.tail_wave,this.head_wave]},this.sample_name=this.sample.find(".sample-name"),this.sample_list=$("#tmpl-sample-list").clone(),this.sample_list.removeAttr("id"),this.sample.find(".file-select").append(this.sample_list),this.sample_list_wrapper=$('<div class="sample-list-wrapper"></div>'),this.sample.find(".file-select").append(this.sample_list_wrapper),this.initEvent(),this.updateEQCanvas()}return t.prototype.getWaveformPos=function(t){return t.clientX-this.canvas_waveform.getBoundingClientRect().left},t.prototype.initEvent=function(){var t;return this.sample.find("input").on("change",function(t){return function(){return t.fetchSampleTimeParam(),t.updateWaveformCanvas(t.sample_now)}}(this)),this.canvas_waveform_dom.on("mousedown",function(t){return function(e){var i;return i=t.getWaveformPos(e),t.clicked_wave=i,t.target_wave=Math.abs(i-t.head_wave)<3?"head":Math.abs(i-t.tail_wave)<3?"tail":t.head_wave<i&&i<t.tail_wave?"both":void 0}}(this)).on("mousemove",function(t){return function(e){var i,s;return null!=t.target_wave?(s=t.getWaveformPos(e),i=s-t.clicked_wave,"head"===t.target_wave?(i=Math.max(i,-t.head_wave),t.head_wave+=i):"tail"===t.target_wave?(i=Math.min(i,t.w_wave-t.tail_wave),t.tail_wave+=i):(i=Math.max(Math.min(i,t.w_wave-t.tail_wave),-t.head_wave),t.head_wave+=i,t.tail_wave+=i),t.fetchSampleTimeParam(),t.updateWaveformCanvas(t.sample_now),t.clicked_wave=s):void 0}}(this)).on("mouseup mouseout",function(t){return function(){return t.target_wave=void 0,t.updateWaveformCanvas(t.sample_now)}}(this)),this.sample_name.on("click",function(t){return function(){return t.showSampleList()}}(this)),t=this,this.sample_list.find("div").on("click",function(){return t.setSample($(this).html()),t.hideSampleList()}),this.sample_list_wrapper.on("click",function(t){return function(){return t.hideSampleList()}}(this)),this.eq.on("change",function(t){return function(){return t.fetchSampleEQParam(),t.updateEQCanvas()}}(this)),this.output.on("change",function(t){return function(){return t.fetchSampleOutputParam()}}(this))},t.prototype.bindSample=function(t,e){return this.sample_now=t,this.sample_name.find("span").text(e.wave),this.updateWaveformCanvas(this.sample_now),this.updateEQCanvas()},t.prototype.showSampleList=function(){var t;return t=this.sample_name.position(),this.sample_list.show().css({top:t.top+20+"px",left:t.left+"px"}),this.sample_list_wrapper.show()},t.prototype.hideSampleList=function(){return this.sample_list.hide(),this.sample_list_wrapper.hide()},t.prototype.updateWaveformCanvas=function(t){var e,i,s,n,a,o,r,h,l,c,p,f;if(this.sample_now=t,e=this.canvas_waveform,i=this.ctx_waveform,h=e.width=this.w_wave,n=e.height=this.h_wave-10,i.clearRect(0,0,h,n),i.translate(0,10),a=this.model.getSampleTimeParam(this.sample_now),p=this.model.getSampleData(this.sample_now),null!=p){for(l=p.getChannelData(0),i.translate(0,n/2),i.beginPath(),s=l.length/h,c=f=0;h>=0?h>f:f>h;c=h>=0?++f:--f)i.lineTo(c,l[Math.floor(c*s)]*n*.45);i.closePath(),i.strokeStyle="rgb(255, 0, 220)",i.stroke(),i.translate(0,-n/2)}return o=a[0]*h,r=a[1]*h,r>o&&(i.fillStyle=null!=this.target_wave?"rgba(255, 0, 160, 0.1)":"rgba(255, 0, 160, 0.2)",i.fillRect(o,0,r-o,n)),i.beginPath(),i.arc(o,-5,5,0,2*Math.PI,!1),i.closePath(),i.stroke(),i.beginPath(),i.arc(r,-5,5,0,2*Math.PI,!1),i.stroke(),i.closePath()},t.prototype.updateEQCanvas=function(){var t,e,i,s,n;return t=this.canvas_EQ,e=this.ctx_EQ,n=t.width=270,s=t.height=100,i=this.model.getSampleEQParam(this.sample_now),e.clearRect(0,0,n,s),e.translate(0,s/2),e.beginPath(),e.moveTo(0,-(i[0]/100)*(s/2)),e.lineTo(n/3,-(i[1]/100)*(s/2)),e.lineTo(n/3*2,-(i[1]/100)*(s/2)),e.lineTo(n,-(i[2]/100)*(s/2)),e.strokeStyle="rgb(255, 0, 220)",e.stroke(),e.closePath(),e.translate(0,-s/2)},t.prototype.setSample=function(t){return this.model.setSample(this.sample_now,t),this.sample_name.find("span").text(t)},t.prototype.fetchSampleTimeParam=function(){return this.model.setSampleTimeParam(this.sample_now,this.head_wave/300,this.tail_wave/300,Math.pow(10,parseFloat(this.sample.find(".speed").val())/100-1))},t.prototype.fetchSampleEQParam=function(){return this.model.setSampleEQParam(this.sample_now,parseFloat(this.eq.find(".EQ_lo").val())-100,parseFloat(this.eq.find(".EQ_mid").val())-100,parseFloat(this.eq.find(".EQ_hi").val())-100)},t.prototype.fetchSampleOutputParam=function(){return this.model.setSampleOutputParam(this.sample_now,1-parseFloat(this.panner.val())/200,parseFloat(this.gain.val())/100)},t.prototype.setSampleTimeParam=function(t){var e;return this.head_wave=300*t[0],this.tail_wave=300*t[1],e=Math.log(t[2])/Math.LN10+1,this.sample.find(".speed").val(100*e)},t.prototype.setSampleEQParam=function(t){return this.eq.find(".EQ_lo").val(t[0]+100),this.eq.find(".EQ_mid").val(t[1]+100),this.eq.find(".EQ_hi").val(t[2]+100)},t.prototype.setSampleOutputParam=function(t){var e,i;return i=t[0],e=t[1],this.panner.val(200*(1-i)),this.gain.val(100*e)},t.prototype.fetchGains=function(){var t,e,i,s;for(s=[],t=e=0,i=this.gain_inputs.length;i>=0?i>e:e>i;t=i>=0?++e:--e)s.push(this.model.setNodeGain(t,parseInt(this.gain_inputs.eq(t).val())));return s},t}(),this.SamplerView=function(){function t(t,e){this.model=t,this.id=e,this.dom=$("#tmpl_sampler").clone(),this.dom.attr("id","sampler"+e),$("#instruments").append(this.dom),this.synth_name=this.dom.find(".synth-name"),this.synth_name.val(this.model.name),this.pattern_name=this.dom.find(".pattern-name"),this.pattern_name.val(this.model.pattern_name),this.synth_type=this.dom.find(".synth-type"),this.header=this.dom.find(".header"),this.markers=this.dom.find(".markers"),this.pos_markers=this.dom.find(".marker"),this.marker_prev=this.dom.find(".marker-prev"),this.marker_next=this.dom.find(".marker-next"),this.plus=this.dom.find(".pattern-plus"),this.minus=this.dom.find(".pattern-minus"),this.nosync=this.dom.find(".pattern-nosync"),this.is_nosync=!1,this.setMarker(),this.table_wrapper=this.dom.find(".sequencer-table"),this.canvas_hover_dom=this.dom.find(".table-hover"),this.canvas_on_dom=this.dom.find(".table-on"),this.canvas_off_dom=this.dom.find(".table-off"),this.canvas_hover=this.canvas_hover_dom[0],this.canvas_on=this.canvas_on_dom[0],this.canvas_off=this.canvas_off_dom[0],this.ctx_hover=this.canvas_hover.getContext("2d"),this.ctx_on=this.canvas_on.getContext("2d"),this.ctx_off=this.canvas_off.getContext("2d"),this.cell=new Image,this.cell.src="static/img/sequencer_cell.png",this.cell.onload=function(t){return function(){return t.initCanvas()}}(this),this.cells_x=32,this.cells_y=10,this.core=this.dom.find(".sampler-core"),this.keyboard=new SamplerKeyboardView(this),this.pattern=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this.pattern_obj={name:this.pattern_name.val(),pattern:this.pattern},this.page=0,this.page_total=1,this.last_time=0,this.last_page=0,this.is_clicked=!1,this.hover_pos={x:-1,y:-1},this.click_pos={x:-1,y:-1},this.initEvent(),this.initCanvas()}return t.prototype.initCanvas=function(){var t,e,i,s,n,a;for(this.canvas_hover.width=this.canvas_on.width=this.canvas_off.width=832,this.canvas_hover.height=this.canvas_on.height=this.canvas_off.height=260,this.rect=this.canvas_off.getBoundingClientRect(),this.offset={x:this.rect.left,y:this.rect.top},t=i=0,n=this.cells_y;n>=0?n>i:i>n;t=n>=0?++i:--i)for(e=s=0,a=this.cells_x;a>=0?a>s:s>a;e=a>=0?++s:--s)this.ctx_off.drawImage(this.cell,0,26,26,26,26*e,26*t,26,26);return this.setPattern(this.pattern_obj)},t.prototype.getPos=function(t){var e,i;return this.rect=this.canvas_off.getBoundingClientRect(),e=Math.floor((t.clientX-this.rect.left)/26),i=Math.floor((t.clientY-this.rect.top)/26),i=Math.min(9,i),{x:e,y:i,x_abs:this.page*this.cells_x+e,y_abs:i,note:this.cells_y-i}},t.prototype.initEvent=function(){return this.canvas_hover_dom.on("mousemove",function(t){return function(e){var i;return i=t.getPos(e),i!==t.hover_pos&&(t.ctx_hover.clearRect(26*t.hover_pos.x,26*t.hover_pos.y,26,26),t.ctx_hover.drawImage(t.cell,52,26,26,26,26*i.x,26*i.y,26,26),t.hover_pos=i),t.is_clicked&&t.click_pos!==i?(t.is_adding?t.addNote(i,1):t.removeNote(i),t.click_pos=i):void 0}}(this)).on("mousedown",function(t){return function(e){var i,s,n,a,o,r;for(t.is_clicked=!0,s=t.getPos(e),n=!1,r=t.pattern[s.x_abs],a=0,o=r.length;o>a;a++)i=r[a],i[0]===s.note&&(n=!0);return n?t.removeNote(s):(t.is_adding=!0,t.addNote(s,1))}}(this)).on("mouseup",function(t){return function(){return t.is_clicked=!1,t.is_adding=!1,t.is_removing=!1}}(this)).on("mouseout",function(t){return function(){return t.ctx_hover.clearRect(26*t.hover_pos.x,26*t.hover_pos.y,26,26),t.hover_pos={x:-1,y:-1},t.is_clicked=!1,t.is_adding=!1,t.is_removing=!1}}(this)),this.synth_type.on("change",function(t){return function(){return t.model.changeSynth(t.synth_type.val())}}(this)),this.synth_name.on("focus",function(){return function(){return window.keyboard.beginInput()}}(this)).on("blur",function(){return function(){return window.keyboard.endInput()}}(this)).on("change",function(t){return function(){return t.model.setSynthName(t.synth_name.val())}}(this)),this.pattern_name.on("focus",function(){return function(){return window.keyboard.beginInput()}}(this)).on("blur",function(){return function(){return window.keyboard.endInput()}}(this)).on("change",function(t){return function(){return t.model.setPatternName(t.pattern_name.val())}}(this)),this.marker_prev.on("click",function(t){return function(){return t.model.player.backward(!0)}}(this)),this.marker_next.on("click",function(t){return function(){return t.model.player.forward()}}(this)),this.nosync.on("click",function(t){return function(){return t.toggleNoSync()}}(this)),this.plus.on("click",function(t){return function(){return t.plusPattern()}}(this)),this.minus.on("click",function(t){return function(){return t.pattern.length>t.cells_x?t.minusPattern():void 0}}(this))},t.prototype.addNote=function(t,e){var i,s,n;for(0===this.pattern[t.x_abs]&&(this.pattern[t.x_abs]=[]),Array.isArray(this.pattern[t.x_abs])||(this.pattern[t.x_abs]=[[this.pattern[t.x_abs],1]]),i=s=0,n=this.pattern[t.x_abs].length;n>=0?n>s:s>n;i=n>=0?++s:--s)this.pattern[t.x_abs][i][0]===t.note&&this.pattern[t.x_abs].splice(i,1);return this.pattern[t.x_abs].push([t.note,e]),this.model.addNote(t.x_abs,t.note,e),this.ctx_on.drawImage(this.cell,26,26,26,26,26*t.x,26*t.y,26,26)},t.prototype.removeNote=function(t){var e,i,s;for(e=i=0,s=this.pattern[t.x_abs].length;s>=0?s>i:i>s;e=s>=0?++i:--i)this.pattern[t.x_abs][e][0]===t.note&&this.pattern[t.x_abs].splice(e,1);return this.ctx_on.clearRect(26*t.x,26*t.y,26,26),this.model.removeNote(t)},t.prototype.playAt=function(t){var e,i,s;if(this.time=t,!this.is_nosync){for(this.time%this.cells_x===0&&this.drawPattern(this.time),e=i=0,s=this.cells_y;s>=0?s>i:i>s;e=s>=0?++i:--i)this.ctx_off.drawImage(this.cell,0,26,26,26,this.last_time%this.cells_x*26,26*e,26,26),this.ctx_off.drawImage(this.cell,78,26,26,26,t%this.cells_x*26,26*e,26,26);return this.last_time=t}},t.prototype.setPattern=function(t){return this.pattern_obj=t,this.pattern=this.pattern_obj.pattern,this.page=0,this.page_total=this.pattern.length/this.cells_x,this.drawPattern(0),this.setMarker(),this.setPatternName(this.pattern_obj.name)},t.prototype.drawPattern=function(t){var e,i,s,n,a,o,r,h;for(null!=t&&(this.time=t),this.page=Math.floor(this.time/this.cells_x),this.ctx_on.clearRect(0,0,832,260),e=n=0,r=this.cells_x;r>=0?r>n:n>r;e=r>=0?++n:--n)for(h=this.pattern[this.page*this.cells_x+e],a=0,o=h.length;o>a;a++)i=h[a],s=this.cells_y-i[0],this.ctx_on.drawImage(this.cell,26,26,26,26,26*e,26*s,26,26);return this.setMarker()},t.prototype.plusPattern=function(){return 8!==this.page_total?(this.pattern=this.pattern.concat([[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]]),this.page_total++,this.model.plusPattern(),this.drawPattern(),this.minus.removeClass("btn-false").addClass("btn-true"),8===this.page_total?this.plus.removeClass("btn-true").addClass("btn-false"):void 0):void 0},t.prototype.minusPattern=function(){return 1!==this.page_total?(this.pattern=this.pattern.slice(0,this.pattern.length-this.cells_x),this.page_total--,this.model.minusPattern(),this.drawPattern(),this.plus.removeClass("btn-false").addClass("btn-true"),1===this.page_total?this.minus.removeClass("btn-true").addClass("btn-false"):void 0):void 0},t.prototype.setMarker=function(){return this.pos_markers.filter(function(t){return function(e){return e<t.page_total}}(this)).addClass("marker-active"),this.pos_markers.filter(function(t){return function(e){return t.page_total<=e}}(this)).removeClass("marker-active"),this.pos_markers.removeClass("marker-now").eq(this.page).addClass("marker-now"),this.markers.find(".marker-pos").text(this.page+1),this.markers.find(".marker-total").text(this.page_total),this.pos_markers.filter(function(t){return function(e){return e<t.page_total}}(this)).each(function(t){return function(e){return t.pos_markers.eq(e).on("mousedown",function(){var i;if(t.page<e)for(;t.page!==e;)t.model.player.forward();if(e<t.page){for(i=[];t.page!==e;)i.push(t.model.player.backward(!0));return i}})}}(this))},t.prototype.play=function(){},t.prototype.stop=function(){var t,e,i,s;for(s=[],t=e=0,i=this.cells_y;i>=0?i>e:e>i;t=i>=0?++e:--e)s.push(this.ctx_off.drawImage(this.cell,0,26,26,26,this.last_time%this.cells_x*26,26*t,26,26));return s},t.prototype.activate=function(){return this.is_active=!0,this.initCanvas()},t.prototype.inactivate=function(){return this.is_active=!1},t.prototype.setSynthName=function(t){return this.synth_name.val(t)},t.prototype.setPatternName=function(t){return this.pattern_name.val(t)},t.prototype.toggleNoSync=function(){var t,e,i,s;if(this.is_nosync)return this.is_nosync=!1,this.nosync.removeClass("btn-true").addClass("btn-false"),this.drawPattern(this.time);for(this.is_nosync=!0,this.nosync.removeClass("btn-false").addClass("btn-true"),s=[],t=e=0,i=this.cells_y;i>=0?i>e:e>i;t=i>=0?++e:--e)s.push(this.ctx_off.drawImage(this.cell,0,26,26,26,this.time%this.cells_x*26,26*t,26,26));return s},t.prototype.selectSample=function(t){return this.sample_now=t,this.keyboard.selectSample(this.sample_now),this.model.selectSample(this.sample_now)},t}(),this.SamplerKeyboardView=function(){function t(t){this.sequencer=t,this.on_dom=this.sequencer.dom.find(".keyboard-off"),this.off_dom=this.sequencer.dom.find(".keyboard-on"),this.canvas_on=this.on_dom[0],this.canvas_off=this.off_dom[0],this.ctx_on=this.canvas_on.getContext("2d"),this.ctx_off=this.canvas_off.getContext("2d"),this.w=64,this.h=26,this.cells_y=10,this.color=["rgba(230, 230, 230, 1.0)","rgba(  250, 50, 230, 0.7)","rgba(255, 100, 230, 0.7)","rgba(200, 200, 200, 1.0)","rgba(255, 255, 255, 1.0)"],this.is_clicked=!1,this.hover_pos={x:-1,y:-1},this.click_pos={x:-1,y:-1},this.initCanvas(),this.initEvent()}return t.prototype.initCanvas=function(){var t,e,i,s;for(this.canvas_on.width=this.canvas_off.width=this.w,this.canvas_on.height=this.canvas_off.height=this.h*this.cells_y,this.rect=this.canvas_off.getBoundingClientRect(),this.offset={x:this.rect.left,y:this.rect.top},this.ctx_off.fillStyle=this.color[0],s=[],t=e=0,i=this.cells_y;i>=0?i>e:e>i;t=i>=0?++e:--e)this.drawNormal(t),s.push(this.drawText(t));return s},t.prototype.getPos=function(t){return this.rect=this.canvas_off.getBoundingClientRect(),Math.floor((t.clientY-this.rect.top)/this.h)},t.prototype.initEvent=function(){return this.off_dom.on("mousemove",function(t){return function(e){var i;return i=t.getPos(e),i!==t.hover_pos&&(t.drawNormal(t.hover_pos),t.drawHover(i),t.hover_pos=i),t.is_clicked&&t.click_pos!==i?(t.clearActive(t.click_pos),t.drawActive(i),t.sequencer.model.noteOff(),t.sequencer.model.noteOn(t.cells_y-i),t.click_pos=i):void 0}}(this)).on("mousedown",function(t){return function(e){var i,s;return t.is_clicked=!0,s=t.getPos(e),i=t.cells_y-s,t.sequencer.selectSample(i-1),t.drawActive(s),t.sequencer.model.noteOn(i),t.click_pos=s}}(this)).on("mouseup",function(t){return function(){return t.is_clicked=!1,t.clearActive(t.click_pos),t.sequencer.model.noteOff(),t.click_pos={x:-1,y:-1}}}(this)).on("mouseout",function(t){return function(){return t.clearActive(t.hover_pos),t.sequencer.model.noteOff(),t.hover_pos={x:-1,y:-1},t.click_pos={x:-1,y:-1}}}(this))},t.prototype.drawNormal=function(t){return this.clearNormal(t),this.ctx_off.fillStyle=this.color[0],this.ctx_off.fillRect(0,(t+1)*this.h-3,this.w,2),this.ctx_off.fillStyle=this.color[3],this.ctx_off.fillText((this.cells_y-t-1)%7+1+"th",10,(t+1)*this.h-10)},t.prototype.drawHover=function(t){return this.ctx_off.fillStyle=this.color[1],this.ctx_off.fillRect(0,(t+1)*this.h-3,this.w,2),this.ctx_off.fillText((this.cells_y-t-1)%7+1+"th",10,(t+1)*this.h-10)},t.prototype.drawActive=function(t){return this.clearNormal(t),this.ctx_off.fillStyle=this.color[2],this.ctx_off.fillRect(0,t*this.h,this.w,this.h),this.ctx_off.fillStyle=this.color[4],this.ctx_off.fillText((this.cells_y-t-1)%7+1+"th",10,(t+1)*this.h-10)},t.prototype.clearNormal=function(t){return this.ctx_off.clearRect(0,t*this.h,this.w,this.h)},t.prototype.clearActive=function(t){return this.clearNormal(t),this.drawNormal(t),this.drawText(t)},t.prototype.drawText=function(t){return this.ctx_off.fillStyle=this.color[3],this.ctx_off.fillText((this.cells_y-t-1)%7+1+"th",10,(t+1)*this.h-10)},t.prototype.selectSample=function(t){return this.ctx_on.clearRect(0,(this.cells_y-this.sample_last-1)*this.h,this.w,this.h),this.ctx_on.fillStyle="rgba(255, 200, 230, 0.3)",this.ctx_on.fillRect(0,(this.cells_y-t-1)*this.h,this.w,this.h),this.sample_last=t},t}()}).call(this);