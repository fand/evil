(function(){var t=[].indexOf||function(t){for(var s=0,e=this.length;e>s;s++)if(s in this&&this[s]===t)return s;return-1};this.Player=function(){function s(){this.bpm=120,this.duration=500,this.key="A",this.scale="Major",this.is_playing=!1,this.time=0,this.scene={bpm:this.bpm,key:this.key,scale:this.scale},this.num_id=0,this.context=CONTEXT,this.synth=[],this.mixer=new Mixer(this.context,this),this.session=new Session(this.context,this),this.sidebar=new Sidebar(this.context,this,this.session,this.mixer),this.addSynth(0),this.synth_now=this.synth[0],this.synth_pos=0,this.scene_length=32,this.view=new PlayerView(this)}return s.prototype.setBPM=function(t){var s,e,i,n;for(this.bpm=t,this.scene.bpm=this.bpm,this.duration=7500/this.bpm,n=this.synth,e=0,i=n.length;i>e;e++)s=n[e],s.setDuration(this.duration);return this.sidebar.setBPM(this.bpm)},s.prototype.setKey=function(t){var s,e,i,n;for(this.key=t,this.scene.key=this.key,n=this.synth,e=0,i=n.length;i>e;e++)s=n[e],s.setKey(this.key);return this.sidebar.setKey(this.key)},s.prototype.setScale=function(t){var s,e,i,n;for(this.scale=t,this.scene.scale=this.scale,n=this.synth,e=0,i=n.length;i>e;e++)s=n[e],s.setScale(this.scale);return this.sidebar.setScale(this.scale)},s.prototype.isPlaying=function(){return this.is_playing},s.prototype.play=function(){return this.is_playing=!0,this.session.play(),T.setTimeout(function(t){return function(){return t.playNext()}}(this),150)},s.prototype.stop=function(){var t,s,e,i;for(i=this.synth,s=0,e=i.length;e>s;s++)t=i[s],t.stop();return this.is_playing=!1,this.view.viewStop(),this.time=0},s.prototype.pause=function(){var t,s,e,i;for(i=this.synth,s=0,e=i.length;e>s;s++)t=i[s],t.pause(this.time);return this.is_playing=!1},s.prototype.forward=function(){return this.time+32>this.scene_length&&this.session.nextMeasure(this.synth),this.time=(this.time+32)%this.scene_length,this.synth_now.redraw(this.time)},s.prototype.backward=function(t){return t?this.time>=32&&(this.time=(this.time-32)%this.scene_length):this.time=this.time%32<3&&this.time>=32?(this.time-32-this.time%32)%this.scene_length:this.time-this.time%32,this.synth_now.redraw(this.time)},s.prototype.toggleLoop=function(){return this.session.toggleLoop()},s.prototype.noteOn=function(t,s){return this.synth_now.noteOn(t,s)},s.prototype.noteOff=function(t){return this.synth_now.noteOff(t)},s.prototype.playNext=function(){var t,s,e,i;if(this.is_playing){for(this.time>=this.scene_length&&(this.time=0),i=this.synth,s=0,e=i.length;e>s;s++)t=i[s],t.playAt(this.time);return this.time%32===31&&this.time+32>this.scene_length&&this.session.nextMeasure(this.synth),this.time%8===0&&this.session.beat(),this.time++,T.setTimeout(function(t){return function(){return t.playNext()}}(this),this.duration)}return this.stop()},s.prototype.addSynth=function(t,s){var e;return e=new Synth(this.context,this.num_id++,this,s),e.setScale(this.scene.scale),e.setKey(this.scene.key),this.synth.push(e),this.mixer.addSynth(e),this.session.addSynth(e,t)},s.prototype.addSampler=function(t,s){var e;return e=new Sampler(this.context,this.num_id++,this,s),this.synth.push(e),this.mixer.addSynth(e),this.session.addSynth(e,t)},s.prototype.changeSynth=function(t,s){var e,i;return i=this.synth[t],"REZ"===s?(e=new Synth(this.context,t,this,i.name),e.setScale(this.scene.scale),e.setKey(this.scene.key)):"SAMPLER"===s&&(e=new Sampler(this.context,t,this,i.name)),this.synth_now=this.synth[t]=e,this.synth_now=e,this.mixer.changeSynth(t,e),this.session.changeSynth(t,s,e),this.view.changeSynth(t,s),e},s.prototype.moveRight=function(t){return t===this.synth.length&&(this.addSynth(),this.session.play()),this.synth[t-1].inactivate(),this.synth_now=this.synth[t],this.synth_now.activate(t),this.synth_pos++,window.keyboard.setMode("SYNTH")},s.prototype.moveLeft=function(t){return this.synth[t+1].inactivate(),this.synth_now=this.synth[t],this.synth_now.activate(t),this.synth_pos--,window.keyboard.setMode("SYNTH")},s.prototype.moveTop=function(){return window.keyboard.setMode("MIXER")},s.prototype.moveBottom=function(){return window.keyboard.setMode("SYNTH")},s.prototype.moveTo=function(t){var s,e;if(this.view.moveBottom(),t<this.synth_pos){for(s=[];t!==this.synth_pos;)s.push(this.view.moveLeft());return s}for(e=[];t!==this.synth_pos;)e.push(this.view.moveRight());return e},s.prototype.solo=function(s){var e,i,n,h,o,r,y,a,c;{if(0!==s.length){for(y=this.synth,c=[],n=0,o=y.length;o>n;n++)e=y[n],a=e.id+1,c.push(t.call(s,a)>=0?e.demute():e.mute());return c}for(r=this.synth,i=0,h=r.length;h>i;i++)e=r[i],e.demute()}},s.prototype.readSong=function(t){var s,e,i,n,h;for(this.song=t,this.synth=[],this.num_id=0,this.mixer.empty(),this.session.empty(),this.view.empty(),s=e=0,n=this.song.tracks.length;n>=0?n>e:e>n;s=n>=0?++e:--e)(null==this.song.tracks[s].type||"REZ"===this.song.tracks[s].type)&&this.addSynth(0,this.song.tracks[s].name),"SAMPLER"===this.song.tracks[s].type&&this.addSampler(0,this.song.tracks[s].name);for(this.synth_now=this.synth[0],this.readScene(this.song.master[0]),this.setSceneLength(this.song.master.length),s=i=0,h=this.song.tracks.length;h>=0?h>i:i>h;s=h>=0?++i:--i)this.synth[s].setParam(this.song.tracks[s]);return this.session.setSynth(this.synth),this.session.readSong(this.song),this.mixer.readParam(this.song.mixer),this.view.setSynthNum(this.synth.length,this.synth_pos),this.resetSceneLength()},s.prototype.clearSong=function(){return this.synth=[],this.num_id=0},s.prototype.readScene=function(t){return null!=t.bpm&&(this.setBPM(t.bpm),this.view.setBPM(t.bpm)),null!=t.key&&(this.setKey(t.key),this.view.setKey(t.key)),null!=t.scale&&(this.setScale(t.scale),this.view.setScale(t.scale)),this.view.setParam(t.bpm,t.key,t.scale)},s.prototype.getScene=function(){return this.scene},s.prototype.setSceneLength=function(t){this.scene_length=t},s.prototype.resetSceneLength=function(){var t,s,e,i,n;for(this.scene_length=0,i=this.synth,n=[],s=0,e=i.length;e>s;s++)t=i[s],n.push(this.scene_length=Math.max(this.scene_length,t.pattern.length));return n},s.prototype.showSuccess=function(t){return console.log("success!"),console.log(t)},s.prototype.showError=function(t){return console.log(t)},s}()}).call(this);