(function(){var t,e,i,n;this.KEY_LIST={A:55,Bb:58.27047018976124,B:61.7354126570155,C:32.70319566257483,Db:34.64782887210901,D:36.70809598967594,Eb:38.890872965260115,E:41.20344461410875,F:43.653528929125486,Gb:46.2493028389543,G:48.999429497718666,Ab:51.91308719749314},this.SCALE_LIST={Major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],Pentatonic:[0,3,5,7,10],Dorian:[0,2,3,5,7,9,10],Phrygian:[0,1,3,5,7,8,10],Lydian:[0,2,4,6,7,9,11],Mixolydian:[0,2,4,5,7,9,10],CHROMATIC:[0,1,2,3,4,5,6,7,8,9,10,11],"Harm-minor":[0,2,3,5,7,8,11]},e={SINE:0,RECT:1,SAW:2,TRIANGLE:3},i=new MutekiTimer,n=[2,3,5,7,11,13,17],t=[.1,.15,.25,.35,.55,.65,.85],this.Noise=function(){function t(t){this.ctx=t,this.node=this.ctx.createScriptProcessor(STREAM_LENGTH),this.node.onaudioprocess=function(){return function(t){var e,i,n,s,r,o;for(e=t.outputBuffer.getChannelData(0),i=t.outputBuffer.getChannelData(1),o=[],n=s=0,r=e.length;r>=0?r>s:s>r;n=r>=0?++s:--s)o.push(e[n]=i[n]=Math.random());return o}}(this)}return t.prototype.connect=function(t){return this.node.connect(t)},t.prototype.setOctave=function(t){this.octae=t},t.prototype.setFine=function(t){this.fine=t},t.prototype.setNote=function(){},t.prototype.setInterval=function(t){this.interval=t},t.prototype.setFreq=function(){},t.prototype.setKey=function(){},t.prototype.setShape=function(t){this.shape=t},t.prototype.getParam=function(){return{shape:this.shape,octave:this.octave,interval:this.interval,fine:this.fine}},t.prototype.setParam=function(t){return this.shape=t.shape,this.octave=t.octave,this.interval=t.interval,this.fine=t.fine},t}(),this.VCO=function(){function i(t){var e,i;for(this.ctx=t,this.freq_key=55,this.octave=4,this.interval=0,this.fine=0,this.note=0,this.freq=Math.pow(2,this.octave)*this.freq_key,this.node=this.ctx.createGain(),this.node.gain.value=1,this.osc=this.ctx.createOscillator(),this.osc.type=0,this.oscs=[this.ctx.createOscillator(),this.ctx.createOscillator(),this.ctx.createOscillator(),this.ctx.createOscillator(),this.ctx.createOscillator(),this.ctx.createOscillator(),this.ctx.createOscillator()],this.setFreq(),this.osc.start(0),e=i=0;7>i;e=++i)this.oscs[e].start(n[e])}return i.prototype.setOctave=function(t){this.octave=t},i.prototype.setNote=function(t){this.note=t},i.prototype.setKey=function(t){this.freq_key=t},i.prototype.setInterval=function(t){this.interval=t},i.prototype.setFine=function(t){var e,i,n,s,r;for(this.fine=t,this.osc.detune.value=this.fine,s=this.oscs,r=[],i=0,n=s.length;n>i;i++)e=s[i],r.push(e.detune.value=this.fine);return r},i.prototype.setShape=function(t){var i,n,s,r,o,h,a,c,u,p;if(this.shape=t,"SUPERSAW"===this.shape){for(c=this.oscs,n=0,o=c.length;o>n;n++)i=c[n],i.type=e.SAW,i.connect(this.node);return this.osc.disconnect(),this.node.gain.value=.9}if("SUPERRECT"===this.shape){for(u=this.oscs,s=0,h=u.length;h>s;s++)i=u[s],i.type=e.RECT,i.connect(this.node);return this.osc.disconnect(),this.node.gain.value=.9}for(p=this.oscs,r=0,a=p.length;a>r;r++)i=p[r],i.disconnect();return this.osc.type=e[t],this.osc.connect(this.node),this.node.gain.value=1},i.prototype.setFreq=function(){var e,i,n,s,r;if(i=Math.floor(this.note/12),n=this.note%12,this.freq=Math.pow(2,this.octave+i)*Math.pow(SEMITONE,n)*this.freq_key+this.fine,"SUPERSAW"===this.shape||"SUPERRECT"===this.shape){for(r=[],e=s=0;7>s;e=++s)r.push(this.oscs[e].frequency.setValueAtTime(this.freq+t[e],0));return r}return this.osc.frequency.setValueAtTime(this.freq,0)},i.prototype.connect=function(t){var e,i,n,s;for(this.dst=t,this.osc.connect(this.node),s=this.oscs,i=0,n=s.length;n>i;i++)e=s[i],e.connect(this.node);return this.node.connect(this.dst)},i.prototype.disconnect=function(){return this.node.disconnect()},i.prototype.getParam=function(){return{shape:this.shape,octave:this.octave,interval:this.interval,fine:this.fine}},i.prototype.setParam=function(t){return this.octave=t.octave,this.interval=t.interval,this.fine=t.fine,this.setShape(t.shape)},i}(),this.EG=function(){function t(t,e,i){this.target=t,this.min=e,this.max=i,this.attack=0,this.decay=0,this.sustain=0,this.release=0}return t.prototype.getADSR=function(){return[this.attack,this.decay,this.sustain,this.release]},t.prototype.setADSR=function(t,e,i,n){return this.attack=t/5e4,this.decay=e/5e4,this.sustain=i/100,this.release=n/5e4},t.prototype.getRange=function(){return[this.min,this.max]},t.prototype.setRange=function(t,e){this.min=t,this.max=e},t.prototype.getParam=function(){return{adsr:this.getADSR(),range:this.getRange()}},t.prototype.setParam=function(t){var e;return e=t.adsr,this.attack=e[0],this.decay=e[1],this.sustain=e[2],this.release=e[3],this.setRange(t.range[0],t.range[1])},t.prototype.noteOn=function(t){return this.target.cancelScheduledValues(t),this.target.setValueAtTime(this.target.value,t),this.target.linearRampToValueAtTime(this.max,t+this.attack),this.target.linearRampToValueAtTime(this.sustain*(this.max-this.min)+this.min,t+this.attack+this.decay)},t.prototype.noteOff=function(t){return this.target.linearRampToValueAtTime(this.min,t+this.release),this.target.linearRampToValueAtTime(0,t+this.release+.001),this.target.cancelScheduledValues(t+this.release+.002)},t}(),this.ResFilter=function(){function t(t){this.ctx=t,this.lpf=this.ctx.createBiquadFilter(),this.lpf.type="lowpass",this.lpf.gain.value=1}return t.prototype.connect=function(t){return this.lpf.connect(t)},t.prototype.disconnect=function(){return this.lpf.disconnect()},t.prototype.getResonance=function(){return this.lpf.Q.value},t.prototype.setQ=function(t){return this.lpf.Q.value=t},t.prototype.getQ=function(){return this.lpf.Q.value},t}(),this.SynthCore=function(){function t(t,e,i){var n,s;for(this.parent=t,this.ctx=e,this.id=i,this.node=this.ctx.createGain(),this.node.gain.value=0,this.gain=1,this.is_mute=!1,this.is_on=!1,this.is_harmony=!0,this.scale=this.parent.scale,this.vcos=[new VCO(this.ctx),new VCO(this.ctx),new Noise(this.ctx)],this.gains=[this.ctx.createGain(),this.ctx.createGain(),this.ctx.createGain()],n=s=0;3>s;n=++s)this.vcos[n].connect(this.gains[n]),this.gains[n].gain.value=0,this.gains[n].connect(this.node);this.filter=new ResFilter(this.ctx),this.eg=new EG(this.node.gain,0,this.gain),this.feg=new EG(this.filter.lpf.frequency,0,0),this.gain_res=this.ctx.createGain(),this.gain_res.gain.value=0,this.vcos[2].connect(this.gain_res),this.gain_res.connect(this.node),this.view=new SynthCoreView(this,i,this.parent.view.dom.find(".synth-core"))}return t.prototype.getParam=function(){var t,e;return{type:"REZ",vcos:function(){var t,i,n,s;for(n=this.vcos,s=[],t=0,i=n.length;i>t;t++)e=n[t],s.push(e.getParam());return s}.call(this),gains:function(){var e,i,n,s;for(n=this.gains,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.gain.value);return s}.call(this),eg:this.eg.getParam(),feg:this.feg.getParam(),filter:[this.feg.getRange()[1],this.filter.getQ()],harmony:this.is_harmony}},t.prototype.setParam=function(t){var e,i,n,s,r;if(null!=t.vcos)for(e=i=0,s=t.vcos.length;s>=0?s>i:i>s;e=s>=0?++i:--i)this.vcos[e].setParam(t.vcos[e]);if(null!=t.gains)for(e=n=0,r=t.gains.length;r>=0?r>n:n>r;e=r>=0?++n:--n)this.gains[e].gain.value=t.gains[e];return null!=t.eg&&this.eg.setParam(t.eg),null!=t.feg&&this.feg.setParam(t.feg),null!=t.filter&&(this.feg.setRange(this.feg.getRange()[0],t.filter[0]),this.filter.setQ(t.filter[1])),this.view.setParam(t)},t.prototype.setVCOParam=function(t,e,i,n,s,r){return this.vcos[t].setShape(e),this.vcos[t].setOctave(i),this.vcos[t].setInterval(n),this.vcos[t].setFine(s),this.vcos[t].setFreq(),null!=r?this.is_harmony="harmony"===r:void 0},t.prototype.setEGParam=function(t,e,i,n){return this.eg.setADSR(t,e,i,n)},t.prototype.setFEGParam=function(t,e,i,n){return this.feg.setADSR(t,e,i,n)},t.prototype.setFilterParam=function(t,e){return this.feg.setRange(80,25e3*Math.pow(t/1e3,2)+80),this.filter.setQ(e),e>1?this.gain_res.gain.value=.1*(e/1e3):void 0},t.prototype.setVCOGain=function(t,e){return this.gains[t].gain.value=e/100*.3},t.prototype.setGain=function(t){return this.gain=t,this.eg.setRange(0,this.gain)},t.prototype.noteOn=function(){var t;if(!this.is_mute&&!this.is_on)return t=this.ctx.currentTime,this.eg.noteOn(t),this.feg.noteOn(t),this.is_on=!0},t.prototype.noteOff=function(){var t;if(this.is_on)return t=this.ctx.currentTime,this.eg.noteOff(t),this.feg.noteOff(t),this.is_on=!1},t.prototype.setKey=function(t){var e,i,n,s,r,o;for(e=KEY_LIST[t],r=this.vcos,o=[],n=0,s=r.length;s>n;n++)i=r[n],o.push(i.setKey(e));return o},t.prototype.setScale=function(t){this.scale=t},t.prototype.connect=function(t){return this.node.connect(this.filter.lpf),this.filter.connect(t)},t.prototype.disconnect=function(){return this.filter.disconnect(),this.node.disconnect()},t.prototype.noteToSemitone=function(t,e){var i;return this.is_harmony?(t+=e,e>0&&t--,0>e&&t++,i=12*Math.floor((t-1)/this.scale.length)+this.scale[(t-1)%this.scale.length]):i=12*Math.floor((t-1)/this.scale.length)+this.scale[(t-1)%this.scale.length]+e},t.prototype.setNote=function(t){var e,i,n,s,r;for(this.note=t,s=this.vcos,r=[],i=0,n=s.length;n>i;i++)e=s[i],e.setNote(this.noteToSemitone(this.note,e.interval)),r.push(e.setFreq());return r},t.prototype.mute=function(){return this.is_mute=!0},t.prototype.demute=function(){return this.is_mute=!1},t}(),this.Synth=function(){function t(t,e,i,n){this.ctx=t,this.id=e,this.player=i,this.name=n,this.type="REZ",null==this.name&&(this.name="Synth #"+this.id),this.pattern_name="pattern 0",this.pattern=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pattern_obj={name:this.pattern_name,pattern:this.pattern},this.time=0,this.scale_name="Major",this.scale=SCALE_LIST[this.scale_name],this.view=new SynthView(this,this.id),this.core=new SynthCore(this,this.ctx,this.id),this.is_on=!1,this.is_sustaining=!1,this.is_performing=!1,this.session=this.player.session,this.send=this.ctx.createGain(),this.send.gain.value=1,this["return"]=this.ctx.createGain(),this["return"].gain.value=1,this.core.connect(this.send),this.send.connect(this["return"]),this.effects=[],this.T=new MutekiTimer}return t.prototype.connect=function(t){return this["return"].connect(t instanceof Panner?t["in"]:t)},t.prototype.disconnect=function(){return this["return"].disconnect()},t.prototype.setDuration=function(t){this.duration=t},t.prototype.setKey=function(t){return this.core.setKey(t)},t.prototype.setNote=function(t){return this.core.setNote(t)},t.prototype.setScale=function(t){return this.scale_name=t,this.scale=SCALE_LIST[this.scale_name],this.core.scale=this.scale,this.view.changeScale(this.scale)},t.prototype.setGain=function(t){return this.core.setGain(t)},t.prototype.getGain=function(){return this.core.gain},t.prototype.noteOn=function(t,e){return(e||!this.is_performing)&&(this.core.setNote(t),this.core.noteOn()),e?this.is_performing=!0:void 0},t.prototype.noteOff=function(t){return t&&(this.is_performing=!1),this.is_performing?void 0:this.core.noteOff()},t.prototype.playAt=function(t){var e,n;return this.time=t,e=this.time%this.pattern.length,this.view.playAt(e),this.is_performing?void 0:0===this.pattern[e]?this.core.noteOff():this.pattern[e]<0?(this.is_sustaining=!0,n=-this.pattern[e],this.core.setNote(n),this.core.noteOn()):"sustain"!==this.pattern[e]?"end"===this.pattern[e]?i.setTimeout(function(t){return function(){return t.core.noteOff()}}(this),this.duration-10):(this.core.setNote(this.pattern[e]),this.core.noteOn(),i.setTimeout(function(t){return function(){return t.core.noteOff()}}(this),this.duration-10)):void 0},t.prototype.play=function(){return this.view.play()},t.prototype.stop=function(){return this.core.noteOff(),this.view.stop()},t.prototype.pause=function(){return this.core.noteOff()},t.prototype.setPattern=function(t){return this.pattern_obj=$.extend(!0,{},t),this.pattern=this.pattern_obj.pattern,this.pattern_name=this.pattern_obj.name,this.view.setPattern(this.pattern_obj)},t.prototype.getPattern=function(){return this.pattern_obj={name:this.pattern_name,pattern:this.pattern},$.extend(!0,{},this.pattern_obj)},t.prototype.clearPattern=function(){return this.pattern=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pattern_obj.pattern=this.pattern,this.view.setPattern(this.pattern_obj)},t.prototype.plusPattern=function(){return this.pattern=this.pattern.concat([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),this.player.resetSceneLength()},t.prototype.minusPattern=function(){return this.pattern=this.pattern.slice(0,this.pattern.length-32),this.player.resetSceneLength()},t.prototype.addNote=function(t,e){return this.pattern[t]=e},t.prototype.removeNote=function(t){return this.pattern[t]=0},t.prototype.sustainNote=function(t,e,i){var n,s;if(t===e)return void(this.pattern[t]=i);for(n=s=t;e>=t?e>s:s>e;n=e>=t?++s:--s)this.pattern[n]="sustain";return this.pattern[t]=-i,this.pattern[e]="end"},t.prototype.activate=function(t){return this.view.activate(t)},t.prototype.inactivate=function(t){return this.view.inactivate(t)},t.prototype.redraw=function(t){return this.time=t,this.view.drawPattern(this.time)},t.prototype.inputPatternName=function(t){return this.pattern_name=t,this.session.setPatternName(this.id,this.pattern_name)},t.prototype.setPatternName=function(t){return this.pattern_name=t,this.view.setPatternName(this.pattern_name)},t.prototype.setSynthName=function(t){return this.name=t,this.session.setSynthName(this.id,this.name),this.view.setSynthName(this.name)},t.prototype.changeSynth=function(t){var e;return e=this.player.changeSynth(this.id,t,e),this.view.dom.replaceWith(e.view.dom),this.noteOff(!0),this.disconnect()},t.prototype.getParam=function(){var t;return t=this.core.getParam(),t.name=this.name,t.scale_name=this.scale_name,t.effects=this.getEffectsParam(),t},t.prototype.setParam=function(t){return null!=t?(this.core.setParam(t),null!=t.effects?this.setEffects(t.effects):void 0):void 0},t.prototype.mute=function(){return this.core.mute()},t.prototype.demute=function(){return this.core.demute()},t.prototype.setEffects=function(t){var e,i,n,s,r,o,h,a;for(h=this.effects,n=0,r=h.length;r>n;n++)e=h[n],e.disconnect();for(this.effects=[],a=[],s=0,o=t.length;o>s;s++)e=t[s],"Fuzz"===e.effect?i=new Fuzz(this.ctx):"Delay"===e.effect?i=new Delay(this.ctx):"Reverb"===e.effect?i=new Reverb(this.ctx):"Comp"===e.effect?i=new Compressor(this.ctx):"Double"===e.effect&&(i=new Double(this.ctx)),this.insertEffect(i),a.push(i.setParam(e));return a},t.prototype.getEffectsParam=function(){var t,e,i,n,s;for(n=this.effects,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.getParam());return s},t.prototype.insertEffect=function(t){return 0===this.effects.length?(this.send.disconnect(),this.send.connect(t["in"])):(this.effects[this.effects.length-1].disconnect(),this.effects[this.effects.length-1].connect(t["in"])),t.connect(this["return"]),t.setSource(this),this.effects.push(t)},t.prototype.removeEffect=function(t){var e,i;return e=this.effects.indexOf(t),-1!==e?(i=0===e?this.send:this.effects[e-1],i.disconnect(),i.connect(null!=this.effects[e+1]?this.effects[e+1]["in"]:this["return"]),t.disconnect(),this.effects.splice(e,1)):void 0},t}()}).call(this);