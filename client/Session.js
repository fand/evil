(function(){var t;t={name:"section-0",bpm:144,key:"A",scale:"minor"},this.SONG_DEFAULT={tracks:[],length:1,master:[t]},this.Session=function(){function t(t,s){this.ctx=t,this.player=s,this.scenes=[],this.scene_pos=0,this.scene={},this.scene_length=32,this.current_cells=[],this.next_pattern_pos=[],this.next_scene_pos=void 0,this.is_loop=!0,this.is_waiting_next_pattern=!1,this.is_waiting_next_scene=!1,this.cue_queue=[],this.song=SONG_DEFAULT,this.view=new SessionView(this,this.song)}return t.prototype.toggleLoop=function(){return this.is_loop=!this.is_loop},t.prototype.nextMeasure=function(t){return this.synth=t,this.is_loop?this.is_waiting_next_scene?this.nextScene(this.next_scene_pos):this.is_waiting_next_pattern?this.nextPattern():void 0:this.nextScene()},t.prototype.nextPattern=function(){var t,s,e,n,i;for(this.savePatterns(),this.is_waiting_next_pattern=!1,i=this.cue_queue,e=0,n=i.length;n>e;e++)s=i[e],t=this.song.tracks[s[0]].patterns[s[1]],this.synth[s[0]].setPattern(t),this.current_cells[s[0]]=s[1];return this.view.drawScene(this.scene_pos,this.current_cells),this.next_pattern_pos=[],this.cue_queue=[]},t.prototype.nextScene=function(t){var s,e,n,i,r;if(this.savePatterns(),this.is_waiting_next_scene=!1,null==t?(this.scene_pos++,t=this.scene_pos):this.scene_pos=t,this.scene_pos>=this.song.length)return this.player.is_playing=!1,this.view.clearAllActive(),this.scene_pos=this.next_scene_pos=0,void(this.current_cells=function(){var t,s,e,i;for(e=this.song.tracks,i=[],t=0,s=e.length;s>t;t++)n=e[t],i.push(0);return i}.call(this));for(s=i=0,r=this.synth.length;r>=0?r>i:i>r;s=r>=0?++i:--i)null!=this.song.tracks[s].patterns[this.scene_pos]&&(e=this.song.tracks[s].patterns[this.scene_pos],null!=e&&null!==e&&(this.synth[s].setPattern(e),this.scene_length=Math.max(this.scene_length,e.pattern.length),this.current_cells[s]=t));return null!=this.song.master[this.scene_pos]&&this.player.readScene(this.song.master[this.scene_pos]),this.player.setSceneLength(this.scene_length),this.view.readSong(this.song,this.current_cells),this.view.drawScene(this.scene_pos,this.current_cells),this.next_pattern_pos=[],this.next_scene_pos=void 0,this.cue_queue=[]},t.prototype.getScene=function(t){return this.song.master[t]},t.prototype.play=function(){return this.view.drawScene(this.scene_pos,this.current_cells)},t.prototype.beat=function(){return this.is_waiting_next_scene?this.view.beat(!0,[0,this.next_scene_pos]):this.view.beat(!1,this.cue_queue)},t.prototype.cuePattern=function(t,s){return this.is_waiting_next_pattern=!0,this.next_pattern_pos[t]=s,this.cue_queue.push([t,s])},t.prototype.cueScene=function(t){return this.is_waiting_next_scene=!0,this.next_scene_pos=t},t.prototype.next=function(){return this.nextScene(),this.nextPattern()},t.prototype.addSynth=function(t,s){var e,n,i,r;return i=s?s:this.scene_pos,e=t.id+"-"+i,t.setPatternName(e),n=[],n[i]={name:t.pattern_name,pattern:t.pattern},r={id:t.id,type:t.type,name:t.name,patterns:n,params:[],gain:1,pan:0},this.song.tracks.push(r),this.current_cells.push(i),this.view.addSynth(this.song)},t.prototype.setSynth=function(t){this.synth=t},t.prototype.readTrack=function(t,s,e){var n,i;return this.song=t,null==this.song.master[e.y]&&(this.song.master[e.y]={name:"section-"+e.y}),e.y+1>this.song.length&&(this.song.length=e.y+1),n=this.song.tracks[s.x].patterns[s.y].name,i=e.x,this.song.tracks.length<=e.x&&(i=this.song.tracks.length,"REZ"===this.song.tracks[s.x].type?this.player.addSynth(e.y):"SAMPLER"===this.song.tracks[s.x].type&&this.player.addSampler(e.y)),this.song.tracks.length-1},t.prototype.readPattern=function(t,s,e){return this.song.tracks[s].patterns[e]=t,null==this.song.master[e]&&(this.song.master[e]={name:"section-"+e}),e+1>this.song.length&&(this.song.length=e+1),this.current_cells[s]===e?this.player.synth[s].setPattern(t):void 0},t.prototype.readMaster=function(t,s){return this.song.master[s]=t,s+1>this.song.length?this.song.length=s+1:void 0},t.prototype.editPattern=function(t,s){var e,n;return null==this.song.master[s]&&(this.song.master[s]={name:"section-"+s}),s+1>this.song.length&&(this.song.length=s+1),n=t,this.song.tracks.length<=t&&(n=this.song.tracks.length,this.player.addSynth(s)),this.savePattern(n,this.current_cells[n]),null!=this.song.tracks[n].patterns[s]?this.player.synth[n].setPattern(this.song.tracks[n].patterns[s]):(e=n+"-"+s,this.player.synth[n].clearPattern(),this.player.synth[n].setPatternName(e),this.song.tracks[n].patterns[s]=this.player.synth[n].getPattern()),this.current_cells[n]=s,this.view.readSong(this.song,this.current_cells),this.player.moveTo(n),[n,s,this.song.tracks[n].patterns[s]]},t.prototype.savePatterns=function(){var t,s,e,n;for(n=[],t=s=0,e=this.current_cells.length;e>=0?e>s:s>e;t=e>=0?++s:--s)n.push(this.savePattern(t,this.current_cells[t]));return n},t.prototype.savePattern=function(t,s){return this.song.tracks[t].patterns[s]=this.player.synth[t].getPattern()},t.prototype.saveTracks=function(){var t,s,e,n,i;for(i=[],t=e=0,n=this.player.synth.length;n>=0?n>e:e>n;t=n>=0?++e:--e)s=this.player.synth[t].getParam(),null!=this.song.tracks[t].patterns&&(s.patterns=this.song.tracks[t].patterns),i.push(this.song.tracks[t]=s);return i},t.prototype.saveTracksEffect=function(t){return this.song.tracks[t.x].effects=this.player.synth[t.x].getEffectsParam()},t.prototype.saveMaster=function(t,s){return this.song.master[t]=s,this.view.readSong(this.song,this.current_cells),t===this.scene_pos?this.player.readScene(s):void 0},t.prototype.saveMasters=function(){return this.song.master===[]?this.song.master.push(this.player.getScene()):void 0},t.prototype.saveMixer=function(){return this.song.mixer=this.player.mixer.getParam()},t.prototype.saveSong=function(){var t;return this.savePatterns(),this.saveTracks(),this.saveMasters(),this.saveMixer(),t=JSON.stringify(this.song),$.ajax({urpl:"/api/songs/",type:"POST",dataType:"text",data:{title:this.song.title,composer:this.song.creator,json:t}}).done(function(t){return function(s){return t.view.showSuccess(s,t.song.title,t.song.creator)}}(this)).fail(function(t){return function(s){return t.view.showError(s)}}(this))},t.prototype.readSong=function(t){var s,e,n,i;for(this.song=t,this.scene_pos=0,this.scene_length=0,s=n=0,i=this.song.tracks.length;i>=0?i>n:n>i;s=i>=0?++n:--n)e=this.song.tracks[s].patterns[0],null!=e&&null!==e?(this.synth[s].setPattern(e),this.current_cells[s]=0,this.scene_length=Math.max(this.scene_length,e.pattern.length)):this.current_cells[s]=void 0;return this.view.readSong(this.song,this.current_cells)},t.prototype.setSynthName=function(t,s){return this.song.tracks[t].name=s,this.view.drawTrackName(t,s,this.song.tracks[t].type)},t.prototype.setPatternName=function(t,s){var e;return e=this.current_cells[t],null!=this.song.tracks[t].patterns[e]?this.song.tracks[t].patterns[e].name=s:this.song.tracks[t].patterns[e]={name:s},this.view.drawPatternName(t,e,this.song.tracks[t].patterns[e])},t.prototype.changeSynth=function(t,s,e){var n,i,r,h;return n=t+"-"+this.scene_pos,e.setPatternName(n),i=[],i[this.scene_pos]={name:n,pattern:e.pattern},r={id:t,type:s,name:"Synth #"+t,patterns:i,params:[],gain:1,pan:0},this.song.tracks[t]=r,e.setPattern(i[this.scene_pos]),h=[this.song.tracks[t].patterns[this.current_cells[t]],this.song.tracks[t].patterns[0]],this.song.tracks[t].patterns[0]=h[0],this.song.tracks[t].patterns[this.current_cells[t]]=h[1],this.view.addSynth(this.song,[t,this.scene_pos])},t.prototype.empty=function(){return this.next_pattern_pos=[],this.scenes=[],this.scene_pos=0,this.scene={},this.scene_length=32,this.current_cells=[],this.next_pattern_pos=[],this.next_scene_pos=void 0,this.is_loop=!0,this.is_waiting_next_pattern=!1,this.is_waiting_next_scene=!1,this.cue_queue=[],this.song={tracks:[],master:[],length:0,mixer:[]}},t.prototype.deleteCell=function(){var t;return t=this.view.getSelectPos(),null!=t?"tracks"===t.type?(this.song.tracks[t.x].patterns[t.y]=void 0,this.current_cells[t.x]===t.y&&(this.player.synth[t.x].clearPattern(),this.current_cells[t.x]=void 0),this.view.readSong(this.song,this.current_cells)):"master"===t.type?(this.song.master[t.y]={name:this.song.master[t.y].name},this.view.readSong(this.song,this.current_cells)):void 0:void 0},t}()}).call(this);